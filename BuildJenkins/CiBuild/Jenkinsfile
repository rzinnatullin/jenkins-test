pipeline {
    agent {
        node {
            label 'social-build'
            customWorkspace "c:\\jenkins\\ci_buid_${env.BUILD_NUMBER}"
            
        }
    }
    stages {
        stage('Build') {
            steps {
                echo 'Executing build...'
                dir ("${env.WORKSPACE}") {
                    powershell "${env.WORKSPACE}/BuildTeamCity/tl_buildCode.ps1 -CleanBuild -ConfigurationToBuild Debug"
                }
            }
        }
        stage('Unit tests') {
            steps {
                echo 'Run unit tests...'
                dir ("${env.WORKSPACE}") {
                    powershell "${env.WORKSPACE}/BuildJenkins/CiBuild/unittests.ps1" 
                }
            }
        }
    }
    post {
        always {
            echo 'Publishing unit tests results...'
            xunit (
                tools : [ MSTest (pattern: 'TestResults/*.trx') ],
                thresholds : [ skipped(failureThreshold: '0'), failed(failureThreshold: '0') ],
                thresholdMode : 1,
                testTimeMargin : '3000'
            )
            
            echo 'Publishing coverage report...'
            cobertura coberturaReportFile: 'TestResults/Cobertura-coverage.xml'
            
            echo 'Publishing artifacts...'
            archiveArtifacts artifacts: 'output/binaries/**,output/*.wsp,Artifacts/*.zip', allowEmptyArchive: true
        }
    }
}