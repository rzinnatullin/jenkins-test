pipeline {
    agent {
        node {
            label 'social-build'
            customWorkspace "c:\\jenkins\\ci_buid_${env.BUILD_NUMBER}"
            
        }
    }
    stages {
        stage('Build') {
            steps {
                echo 'Executing build...'
                dir ("${env.WORKSPACE}") {
                    powershell "${env.WORKSPACE}/BuildTeamCity/tl_buildCode.ps1 -CleanBuild -ConfigurationToBuild Debug"
                }
            }
        }
        stage('Unit tests') {
            steps {
                echo 'Run unit tests...'
                dir ("${env.WORKSPACE}") {
                    powershell "${env.WORKSPACE}/BuildJenkins/CiBuild/unittests.ps1" 
                }
            }
        }
    }
    post {
        always {
            echo 'Publishing unit tests results...'
            step([$class: 'MSTestPublisher', testResultsFile:"**/*.trx", failOnError: true, keepLongStdio: true])
            
            echo 'Publishing artifacts...'
            archiveArtifacts artifacts: 'output/binaries/**,output/*.wsp,Artifacts/*.zip,TestResults/**', allowEmptyArchive: true
            
            echo 'Publishing coverage report...'
            publishHTML (
                target: [
                    allowMissing: false,
                    alwaysLinkToLastBuild: false,
                    keepAll: true,
                    reportDir: 'TestResults/CoverageReport',
                    reportFiles: 'index.htm',
                    reportName: 'Coverage report'
                ]
            );
            
            echo 'Publishing status to Github...'
            step([
                $class: "GitHubCommitStatusSetter",
                reposSource: [$class: "ManuallyEnteredRepositorySource", url: "https://github.com/rzinnatullin/jenkins-test"],
                contextSource: [$class: "ManuallyEnteredCommitContextSource", context: "ci/jenkins/build-status"],
                errorHandlers: [[$class: "ChangingBuildStatusErrorHandler", result: "UNSTABLE"]],
                statusResultSource: [ $class: "ConditionalStatusResultSource", results: [[$class: "AnyBuildResult", message: message, state: state]] ]
            ]);
        }
    }
}